# LINE 訊息格式優化指南

## 🎯 問題描述

GPT Assistant 在 LINE 上回覆時，文字段落都黏在一起，沒有正確的換行和段落分隔。

## ✅ 解決方案

### 1️⃣ 代碼修復（已完成）

**修改檔案：** `utils/generate-completion.js`

**問題原因：**
原本的代碼使用 `text.replace(/\s+/g, ' ')` 會把所有空白字元（包括換行符號 `\n`）都替換成單一空格，導致段落黏在一起。

**修復後：**
```javascript
// 修復前（會移除換行）
text = text.replace(/\s+/g, ' ').trim();

// 修復後（保留換行）
text = text.replace(/[^\S\n]+/g, ' ');  // 只合併空格，保留換行
text = text.replace(/[^\S\n]+$/gm, ''); // 移除每行尾端空格
text = text.replace(/^[^\S\n]+/gm, ''); // 移除每行開頭空格
text = text.replace(/\n{3,}/g, '\n\n'); // 限制最多連續 2 個換行
text = text.trim();
```

**效果：**
- ✅ 保留段落之間的換行
- ✅ 移除不必要的空白
- ✅ 清理多餘的空行（最多保留一個空行）

---

### 2️⃣ 優化 OpenAI Assistant Instructions

為了獲得最佳的格式化效果，你需要在 OpenAI Platform 上優化 Assistant 的 Instructions。

#### 前往設定

1. 登入 https://platform.openai.com/assistants
2. 選擇你的 Assistant
3. 點擊 Edit

#### 推薦的 Instructions 範例

**方案 A：簡潔版（推薦）**

```
你是友善的 AI 助手，名為「AI助手」。

回答規則：
1. 使用繁體中文
2. 回答要簡潔清晰
3. 使用適當的段落分隔，每個重點之間空一行
4. 列表項目使用「•」或數字編號
5. 重要詞彙可以用【】標註

回答格式範例：
第一段內容。

第二段內容。

• 要點一
• 要點二
• 要點三

總結內容。
```

**方案 B：詳細版**

```
你是友善、專業的 AI 助手。

## 回答風格
- 親切、簡潔、清晰
- 使用繁體中文
- 語氣友善但專業

## 格式要求（重要！）
1. 段落分隔：每個段落之間要有空行
2. 列表格式：
   • 項目列表使用「•」
   • 步驟說明使用數字編號
3. 重點標示：重要詞彙用【】標註
4. 避免過長：每個段落 2-3 句話即可

## 回答範例

當用戶問「如何做蛋糕？」時，應該這樣回答：

做蛋糕需要以下材料：

• 麵粉 200g
• 雞蛋 3顆
• 糖 100g

步驟如下：

1. 將雞蛋打散
2. 加入糖攪拌
3. 慢慢加入麵粉

最後放入烤箱烤 30 分鐘即可！
```

**方案 C：最簡單版（如果字數限制）**

```
你是 AI 助手，用繁體中文回答。

格式要求：
- 段落之間空一行
- 列表用 • 或數字
- 簡潔清晰

範例：
第一段。

第二段。

• 要點一
• 要點二
```

---

### 3️⃣ 測試與驗證

#### 測試訊息

部署修復後，在 LINE 上發送測試訊息：

```
請用三個段落介紹台灣，每個段落說明不同的特色
```

#### 預期結果

**修復前（段落黏在一起）：**
```
台灣是個美麗的島嶼，位於東亞。這裡有豐富的自然景觀和多元文化。台灣美食聞名世界，夜市文化獨特。從小吃到高級料理都有。台灣人民熱情友善，歡迎世界各地的旅客。
```

**修復後（有正確段落）：**
```
台灣是個美麗的島嶼，位於東亞。這裡有豐富的自然景觀和多元文化。

台灣美食聞名世界，夜市文化獨特。從小吃到高級料理都有。

台灣人民熱情友善，歡迎世界各地的旅客。
```

---

## 📋 完整設定檢查清單

### 代碼層面
- [x] 修改 `utils/generate-completion.js`（已完成）
- [ ] 重新部署應用程式
- [ ] 測試換行是否正常

### OpenAI Assistant 設定
- [ ] 登入 OpenAI Platform
- [ ] 編輯 Assistant Instructions
- [ ] 加入格式化要求
- [ ] 儲存設定

### 驗證測試
- [ ] 發送測試訊息
- [ ] 確認段落正確分隔
- [ ] 確認列表格式正確
- [ ] 確認沒有多餘空行

---

## 🎨 LINE 訊息格式最佳實踐

### 支援的格式

LINE 訊息支援純文字和基本格式：

#### ✅ 支援
```
• 換行符號 (\n)
• 空格和縮排
• 特殊符號（•、→、▸、─）
• Emoji 😊
• 【】《》等中文標點
```

#### ❌ 不支援
```
✗ Markdown 語法（**粗體**、*斜體*）
✗ HTML 標籤
✗ 富文本格式
✗ 自訂顏色或字體
```

### 推薦的格式化技巧

#### 1. 段落分隔
```
第一段內容。

第二段內容。

第三段內容。
```

#### 2. 列表格式
```
• 項目一
• 項目二
• 項目三

或

1. 步驟一
2. 步驟二
3. 步驟三
```

#### 3. 標題
```
▸ 主標題

▸▸ 次標題

內容...
```

#### 4. 重點標示
```
這是【重要內容】的說明。
```

#### 5. 分隔線
```
第一部分內容

─────────

第二部分內容
```

---

## 🔧 進階優化

### 如果還是遇到格式問題

#### 1. 檢查 `convertText` 函數

檔案位置：`utils/convert-text.js`

這個函數會：
- 移除過多的空行（超過 2 個連續換行）
- 轉換 Markdown 格式為 LINE 可讀格式

如果需要調整，可以修改第 51 行：
```javascript
// 調整前
converted = converted.replace(/\n{3,}/g, '\n\n');

// 如果想保留更多空行
converted = converted.replace(/\n{4,}/g, '\n\n\n');
```

#### 2. 在 Assistant Instructions 中加強格式要求

如果 AI 還是沒有正確分段，可以加入更明確的指示：

```
【重要！格式規則】
- 每個段落寫完後，必須空一行
- 列表項目前面加 • 
- 長篇回答要分成多個短段落
- 每 2-3 句話就要換段

錯誤示範：
內容內容內容。內容內容。內容內容內容。

正確示範：
內容內容內容。

內容內容。

內容內容內容。
```

#### 3. 使用 System Prompt

如果使用的是舊版 Chat Completions API（非 Assistants API），可以在 system prompt 中加入：

```javascript
const systemPrompt = `你是 AI 助手。

重要：回答時請使用適當的段落分隔。
每個段落之間請空一行。
列表項目請使用 • 符號。`;
```

---

## 📊 格式化效果對比

### 範例問題：「請說明如何煮咖啡」

#### 修復前（段落黏在一起）❌
```
煮咖啡的方法很簡單。首先準備咖啡豆和熱水。將咖啡豆研磨成粉。然後用熱水沖泡咖啡粉。等待 3-4 分鐘即可享用。可以根據個人口味加糖或奶。
```

#### 修復後（格式清晰）✅
```
煮咖啡的方法很簡單！以下是基本步驟：

【準備材料】
• 咖啡豆
• 熱水（90-95°C）
• 咖啡濾紙

【步驟】

1. 將咖啡豆研磨成粉
研磨度依沖泡方式調整

2. 準備熱水
水溫約 90-95°C 最佳

3. 沖泡咖啡
慢慢倒入熱水，等待 3-4 分鐘

4. 享用
可根據個人口味加糖或奶

祝你煮出美味的咖啡！☕
```

---

## 💡 常見問題

### Q1: 修改後還是沒有換行？

**可能原因：**
1. 沒有重新部署
2. 快取問題
3. Assistant Instructions 沒有更新

**解決步驟：**
```bash
# 1. 確認代碼已更新
git status

# 2. 重新部署
vercel --prod
# 或
git push origin main

# 3. 清除快取（如有）
# 在 LINE 中刪除好友再重新加入（極端情況）
```

### Q2: 段落太多空行？

**調整方法：**

在 `utils/generate-completion.js` 中：
```javascript
// 如果想要更少的空行
text = text.replace(/\n{2,}/g, '\n');  // 最多 1 個換行

// 如果想要保留更多空行
text = text.replace(/\n{4,}/g, '\n\n\n');  // 最多 3 個換行
```

### Q3: 列表符號顯示不正確？

**確認 Assistant Instructions 中有指定使用：**
```
列表使用以下符號：
• 項目列表
→ 步驟說明
▸ 標題
```

### Q4: 如何讓 AI 使用 Emoji？

**在 Instructions 中加入：**
```
可以適當使用 emoji 讓回答更生動，例如：
✅ 正確
❌ 錯誤
💡 提示
⚠️ 注意
```

---

## 🎯 最佳配置建議

綜合以上所有優化，以下是最佳配置：

### 1. 代碼修復
✅ `utils/generate-completion.js` - 已修復換行問題

### 2. Assistant Instructions（複製使用）
```
你是友善的 AI 助手。

回答規則：
• 使用繁體中文
• 簡潔清晰
• 適當使用段落分隔（段落間空一行）
• 列表使用 • 或數字
• 重要內容用【】標註

格式範例：

第一段說明。

第二段補充。

重點整理：
• 要點一
• 要點二

希望這樣有幫助！
```

### 3. 部署並測試
```bash
# 部署
vercel --prod

# 測試訊息
"請用列表說明三個台灣景點"
```

### 4. 驗證效果
預期看到：
```
台灣有很多美麗的景點！

推薦以下三個：

• 台北 101
世界知名的摩天大樓

• 日月潭
湖光山色，風景優美

• 墾丁
南台灣的陽光海灘

歡迎來台灣旅遊！
```

---

## 📚 相關文件

- `utils/generate-completion.js` - 文字處理邏輯
- `utils/convert-text.js` - Markdown 轉換
- `app/context.js` - 訊息推送邏輯

---

## ✅ 完成檢查

優化完成後確認：

- [x] 代碼已修改（`utils/generate-completion.js`）
- [ ] 已重新部署
- [ ] Assistant Instructions 已更新
- [ ] 測試訊息格式正確
- [ ] 段落正確分隔
- [ ] 列表格式清晰
- [ ] 沒有多餘空行

---

**修改完成！現在你的 LINE Bot 應該能正確顯示段落了！** 🎉

記得重新部署並更新 Assistant Instructions 以獲得最佳效果。

